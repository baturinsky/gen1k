{const p=150,a=300,n=p*a,k=120,w=r=>~~(Math.sin(++M)**2*1e9%r),x=C.getContext("2d");let M=2,c=4,l,y,o,d=6,b=!0,g=async()=>{o=null;let r=[-1,1,-a,a,a-1,1-a].slice(0,d),u=-1,e=-1,f;y=new Array(n).fill(0),l=new Array(n).fill(-14);for(let i=n*10;--i;i){u=(u+n)%n+r[w(d)],l[u]=(i/n-1)/3+(l[u]+r.map(s=>l[u+s]||0).reduce((s,m)=>s+m,0)/d)/2,l[e]>-5||(e=w(n),f=0);let t=e+r.sort((s,m)=>l[s+e]-l[m+e])[0],h=l[e]-l[t];if(i<n/4&&(y[e]+=f*7),h>0&&t!=null){let s=h/4;l[e]-=s,l[t]+=s,f+=h,e=t}else e=-1}o=l.map((i,t)=>i<0?10:y[t]/k);for(let i=n*25;--i;i){let t=i%n;if(l[t]>-1){let h=w(Math.cos(t/n*6)*9)+r[w(d)]*2;o[t+h]+=o[t]*10/(30+l[t]),o[t+h]=(o[t+h]*4+r.map(s=>o[t+h+s]||0).reduce((s,m)=>s+m,0))/(4+d)}}A()},A=(r=0,u=0)=>{C.width=a*c,C.height=p*c,l.forEach((e,f)=>{let i=Math.sin(f/n*3.14)-e/30,t=o[f]-i*9;x.fillStyle=y[f]>k&&e>=0?"#578":e>=0&&e<22&&b&&o?i<0?"#cce":t>6?"#040":t<0?"#a86":"#560":`rgba(${e<0?"0,40,60,"+(.7-e/30):"60,40,0,"+(e/70+.6)})`,x.fillRect(r+(f%a*c+~~(d==6?~~(f/a)*c/2:0))%(a*c),u+~~(f/a)*c,c,c)})};g(),window.onkeypress=r=>{r.key==1?(b=!b,A()):r.key==2?(d=10-d,g()):(M=r.which,g())}}

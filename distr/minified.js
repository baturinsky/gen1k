{const x=150,r=300,a=x*r,i=4,z=120,b=e=>~~(Math.sin(++A)**2*1e9%e),w=C.getContext("2d");let A=1,t,g,h,d=6,y=!0,k=()=>{let e=[-1,1,-r,r,-1+r,1-r].slice(0,d),l=-1,s=-1;g=new Array(a).fill(0),t=g.map((o,n)=>Math.cos(n/a/2)*10-23);let u;for(let o=a*9;--o;o){l=(l+a)%a+e[b(d)],t[l]=(t[l]+e.map(c=>t[l+c]||0).reduce((c,M)=>c+M,0)/d)/2+(o/a-2)/2,t[s]>-5||(s=b(a),u=0);let n=e.sort((c,M)=>t[c+s]-t[M+s]),f=s+n[0],m=t[s]-t[f];if(o<a/4&&(g[s]+=u*7),m>0&&f!=null){let c=m/4;t[s]-=c,t[f]+=c,u+=m,s=f}else s=-1}h=t.map((o,n)=>o<0?10:g[n]/z);for(let o=a*25;--o;o){let n=o%a;if(t[n]>-1){let f=b(Math.cos(n/a*6)*9)+e[b(d)]*2;h[n+f]+=h[n]*10/(30+t[n]),h[n+f]=(h[n+f]*4+e.map(m=>h[n+f+m]||0).reduce((m,c)=>m+c,0))/(4+d)}}},p=()=>{C.width=r*i,C.height=x*i,t.forEach((e,l)=>{e=~~e;let s=Math.sin(l/a*3.14),u=h[l]-s*9;w.fillStyle=g[l]>z&&e>=0?"#578":e>=0&&e<22&&y?s*25<e?"#cce":u>6?"#040":u<-2?"#a86":"#560":`rgba(${e<0?"0,40,60,"+(.6-e/30):"60,40,0,"+(e/70+.6)})`,w.fillRect((l%r*i+~~(d==6?~~(l/r)*i/2:0))%(r*i),~~(l/r)*i-e,i,i*3),w.beginPath(),w.rect((l%r*i+~~(d==6?~~(l/r)*i/2:0))%(r*i),~~(l/r)*i-e,i,i*3),w.stroke()})};k(),p(),window.onkeypress=e=>{e.key==1?(y=!y,p()):e.key==2?(d=10-d,k(),p()):(A=e.which,k(),p())}}

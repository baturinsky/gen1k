{const k=150,f=300,n=k*f,x=120,w=r=>~~(Math.sin(++M)**2*1e9%r),y=C.getContext("2d");let M=7,c=4,t,b,o,h=6,g=!0,p=()=>{o=null;let r=[-1,1,-f,f,f-1,1-f,f+1,-f-1].slice(0,h),m=-1,e=-1,a;b=new Array(n).fill(0),t=new Array(n).fill(-14);for(let i=n*10;--i;i){m=(m+n)%n+r[w(h)],t[m]=(i/n-1)/3+(t[m]+r.map(s=>t[m+s]||0).reduce((s,u)=>s+u,0)/h)/2,t[e]>-5||(e=w(n),a=0);let l=e+r.sort((s,u)=>t[s+e]-t[u+e])[0],d=t[e]-t[l];if(i<n/4&&(b[e]+=a*7),d>0){let s=d/4;t[e]-=s,t[l]+=s,a+=d,e=l}else e=-1}o=t.map((i,l)=>i<0?10:b[l]/x);for(let i=n*25;--i;i){let l=i%n;if(t[l]>-1){let d=w(Math.cos(l/n*6)*9)+r[w(h)]*2;o[l+d]+=o[l]*10/(30+t[l]),o[l+d]=(o[l+d]*4+r.map(s=>o[l+d+s]||0).reduce((s,u)=>s+u,0))/(4+h)}}A()},A=(r=0,m=0)=>{C.width=f*c,C.height=k*c,y.fillStyle="#fff",y.fillRect(0,0,2e3,1e3),t.forEach((e,a)=>{let i=Math.sin(a/n*3.14)-e/30,l=o[a]-i*9;y.fillStyle=b[a]>x&&e>=0?"#578":e>=0&&e<22&&g&&o?i<0?"#cce":l>6?"#040":l<0?"#a86":"#560":`rgba(${e<0?"0,40,60,"+(.7-e/30):"60,40,0,"+(e/70+.6)})`,y.fillRect(r+(a%f*c+~~(h==6?~~(a/f)*c/2:0))%(f*c),m+~~(a/f)*c,c,c)})};p(),window.onkeypress=r=>{r.key==1?(g=!g,A()):r.key==2?(h=10-h,p()):(M=r.which,p())}}
